apiVersion: v1
items:
- apiVersion: v1
  kind: Service
  metadata:
    annotations:
      argocd.argoproj.io/tracking-id: uniselec-api-prd:/Service:uniselec-api-prd/mariadb
      kubectl.kubernetes.io/last-applied-configuration: |
        {"apiVersion":"v1","kind":"Service","metadata":{"annotations":{"argocd.argoproj.io/tracking-id":"uniselec-api-prd:/Service:uniselec-api-prd/mariadb"},"name":"mariadb","namespace":"uniselec-api-prd"},"spec":{"clusterIP":"None","ports":[{"name":"mysql","port":3306},{"name":"replication","port":4567},{"name":"sst","port":4444},{"name":"ist","port":4568}],"selector":{"app":"mariadb"}}}
    creationTimestamp: "2025-11-15T00:45:32Z"
    name: mariadb
    namespace: uniselec-api-prd
    resourceVersion: "576699828"
    uid: f7d25750-11ee-4bf5-a1a1-a9c7ac8f1bb9
  spec:
    clusterIP: None
    clusterIPs:
    - None
    internalTrafficPolicy: Cluster
    ipFamilies:
    - IPv4
    ipFamilyPolicy: SingleStack
    ports:
    - name: mysql
      port: 3306
      protocol: TCP
      targetPort: 3306
    - name: replication
      port: 4567
      protocol: TCP
      targetPort: 4567
    - name: sst
      port: 4444
      protocol: TCP
      targetPort: 4444
    - name: ist
      port: 4568
      protocol: TCP
      targetPort: 4568
    selector:
      app: mariadb
    sessionAffinity: None
    type: ClusterIP
  status:
    loadBalancer: {}
- apiVersion: v1
  kind: Service
  metadata:
    annotations:
      argocd.argoproj.io/tracking-id: uniselec-api-prd:/Service:uniselec-api-prd/mariadb-app
      kubectl.kubernetes.io/last-applied-configuration: |
        {"apiVersion":"v1","kind":"Service","metadata":{"annotations":{"argocd.argoproj.io/tracking-id":"uniselec-api-prd:/Service:uniselec-api-prd/mariadb-app"},"name":"mariadb-app","namespace":"uniselec-api-prd"},"spec":{"ports":[{"name":"mysql","port":3306}],"selector":{"app":"mariadb"}}}
    creationTimestamp: "2025-11-15T00:45:32Z"
    name: mariadb-app
    namespace: uniselec-api-prd
    resourceVersion: "576699830"
    uid: 2faaac21-a00f-4047-b063-a8ec6c9004d7
  spec:
    clusterIP: 10.98.55.60
    clusterIPs:
    - 10.98.55.60
    internalTrafficPolicy: Cluster
    ipFamilies:
    - IPv4
    ipFamilyPolicy: SingleStack
    ports:
    - name: mysql
      port: 3306
      protocol: TCP
      targetPort: 3306
    selector:
      app: mariadb
    sessionAffinity: None
    type: ClusterIP
  status:
    loadBalancer: {}
- apiVersion: v1
  kind: Service
  metadata:
    annotations:
      argocd.argoproj.io/tracking-id: uniselec-api-prd:/Service:uniselec-api-prd/mariadb-lb
      kubectl.kubernetes.io/last-applied-configuration: |
        {"apiVersion":"v1","kind":"Service","metadata":{"annotations":{"argocd.argoproj.io/tracking-id":"uniselec-api-prd:/Service:uniselec-api-prd/mariadb-lb","metallb.universe.tf/address-pool":"int-pool"},"labels":{"app":"mariadb"},"name":"mariadb-lb","namespace":"uniselec-api-prd"},"spec":{"externalTrafficPolicy":"Cluster","ports":[{"name":"mysql","port":3306,"targetPort":3306}],"selector":{"app":"mariadb"},"type":"LoadBalancer"}}
      metallb.universe.tf/address-pool: int-pool
    creationTimestamp: "2025-11-15T00:45:32Z"
    labels:
      app: mariadb
    name: mariadb-lb
    namespace: uniselec-api-prd
    resourceVersion: "576699850"
    uid: 63f9054f-6428-48d2-8acf-37e07d322283
  spec:
    allocateLoadBalancerNodePorts: true
    clusterIP: 10.96.79.5
    clusterIPs:
    - 10.96.79.5
    externalTrafficPolicy: Cluster
    internalTrafficPolicy: Cluster
    ipFamilies:
    - IPv4
    ipFamilyPolicy: SingleStack
    ports:
    - name: mysql
      nodePort: 30379
      port: 3306
      protocol: TCP
      targetPort: 3306
    selector:
      app: mariadb
    sessionAffinity: None
    type: LoadBalancer
  status:
    loadBalancer:
      ingress:
      - ip: 10.130.0.158
- apiVersion: v1
  kind: Service
  metadata:
    annotations:
      argocd.argoproj.io/tracking-id: uniselec-api-prd:/Service:uniselec-api-prd/mariadb-primary
      kubectl.kubernetes.io/last-applied-configuration: |
        {"apiVersion":"v1","kind":"Service","metadata":{"annotations":{"argocd.argoproj.io/tracking-id":"uniselec-api-prd:/Service:uniselec-api-prd/mariadb-primary"},"labels":{"app":"mariadb","role":"primary"},"name":"mariadb-primary","namespace":"uniselec-api-prd"},"spec":{"clusterIP":"None","ports":[{"name":"mysql","port":3306,"targetPort":"mysql"}],"selector":{"statefulset.kubernetes.io/pod-name":"mariadb-0"}}}
    creationTimestamp: "2025-11-15T00:45:32Z"
    labels:
      app: mariadb
      role: primary
    name: mariadb-primary
    namespace: uniselec-api-prd
    resourceVersion: "576699826"
    uid: c0bf5d13-bdbf-4b60-b7b9-2a695e05e023
  spec:
    clusterIP: None
    clusterIPs:
    - None
    internalTrafficPolicy: Cluster
    ipFamilies:
    - IPv4
    ipFamilyPolicy: SingleStack
    ports:
    - name: mysql
      port: 3306
      protocol: TCP
      targetPort: mysql
    selector:
      statefulset.kubernetes.io/pod-name: mariadb-0
    sessionAffinity: None
    type: ClusterIP
  status:
    loadBalancer: {}
- apiVersion: v1
  kind: Service
  metadata:
    annotations:
      argocd.argoproj.io/tracking-id: uniselec-api-prd:/Service:uniselec-api-prd/mariadb-replicas
      kubectl.kubernetes.io/last-applied-configuration: |
        {"apiVersion":"v1","kind":"Service","metadata":{"annotations":{"argocd.argoproj.io/tracking-id":"uniselec-api-prd:/Service:uniselec-api-prd/mariadb-replicas"},"labels":{"app":"mariadb","role":"replica"},"name":"mariadb-replicas","namespace":"uniselec-api-prd"},"spec":{"clusterIP":"None","ports":[{"name":"mysql","port":3306,"targetPort":"mysql"}],"selector":{"app":"mariadb","mariadb/replication-role":"member"}}}
    creationTimestamp: "2025-11-15T00:45:32Z"
    labels:
      app: mariadb
      role: replica
    name: mariadb-replicas
    namespace: uniselec-api-prd
    resourceVersion: "576699829"
    uid: 1a81d03b-c294-4eb0-a0ea-846508c883a2
  spec:
    clusterIP: None
    clusterIPs:
    - None
    internalTrafficPolicy: Cluster
    ipFamilies:
    - IPv4
    ipFamilyPolicy: SingleStack
    ports:
    - name: mysql
      port: 3306
      protocol: TCP
      targetPort: mysql
    selector:
      app: mariadb
      mariadb/replication-role: member
    sessionAffinity: None
    type: ClusterIP
  status:
    loadBalancer: {}
- apiVersion: v1
  kind: Service
  metadata:
    annotations:
      argocd.argoproj.io/tracking-id: uniselec-api-prd:/Service:uniselec-api-prd/uniselec-api
      kubectl.kubernetes.io/last-applied-configuration: |
        {"apiVersion":"v1","kind":"Service","metadata":{"annotations":{"argocd.argoproj.io/tracking-id":"uniselec-api-prd:/Service:uniselec-api-prd/uniselec-api"},"labels":{"app":"uniselec-api"},"name":"uniselec-api","namespace":"uniselec-api-prd"},"spec":{"ports":[{"name":"http","port":80,"protocol":"TCP","targetPort":80}],"selector":{"app":"uniselec-api"},"type":"ClusterIP"}}
    creationTimestamp: "2025-11-15T00:45:32Z"
    labels:
      app: uniselec-api
    name: uniselec-api
    namespace: uniselec-api-prd
    resourceVersion: "576699845"
    uid: ad4190cc-bef1-42ed-af45-8b573bae5584
  spec:
    clusterIP: 10.104.107.15
    clusterIPs:
    - 10.104.107.15
    internalTrafficPolicy: Cluster
    ipFamilies:
    - IPv4
    ipFamilyPolicy: SingleStack
    ports:
    - name: http
      port: 80
      protocol: TCP
      targetPort: 80
    selector:
      app: uniselec-api
    sessionAffinity: None
    type: ClusterIP
  status:
    loadBalancer: {}
- apiVersion: apps/v1
  kind: StatefulSet
  metadata:
    annotations:
      argocd.argoproj.io/tracking-id: uniselec-api-prd:apps/StatefulSet:uniselec-api-prd/mariadb
      kubectl.kubernetes.io/last-applied-configuration: |
        {"apiVersion":"apps/v1","kind":"StatefulSet","metadata":{"annotations":{"argocd.argoproj.io/tracking-id":"uniselec-api-prd:apps/StatefulSet:uniselec-api-prd/mariadb"},"labels":{"app":"mariadb","component":"database"},"name":"mariadb","namespace":"uniselec-api-prd"},"spec":{"replicas":3,"selector":{"matchLabels":{"app":"mariadb"}},"serviceName":"mariadb","template":{"metadata":{"labels":{"app":"mariadb","mariadb/replication-role":"member"}},"spec":{"containers":[{"command":["bash","-c","#!/bin/bash\n# ======================================================\n# CONFIGURAÇÃO INICIAL DO MARIADB:\n# LOCALE PT-BR, CRIAÇÃO DO BANCO PRINCIPAL,\n# USUÁRIO DE APLICAÇÃO, USUÁRIO DE REPLICAÇÃO,\n# E PERMISSÕES DE ACESSO ROOT\n# ======================================================\n\nset -eo pipefail\n\nmkdir -p /var/lib/mysql/.sst\nchown -Rf mysql:mysql /var/lib/mysql/.sst\nchmod 700 /var/lib/mysql/.sst\n\nexport DEBIAN_FRONTEND=noninteractive\napt-get update\ncommand -v mariabackup || apt-get install -y mariadb-backup\ncommand -v galera-4 || apt-get install -y galera-4\ncommand -v pv || apt-get install -y pv\n\napt-get install -y locales\nsed -i 's/^# *pt_BR.UTF-8 UTF-8/pt_BR.UTF-8 UTF-8/' /etc/locale.gen\nlocale-gen pt_BR.UTF-8\nexport LANG=pt_BR.UTF-8\nexport LC_ALL=pt_BR.UTF-8\nexport LC_CTYPE=pt_BR.UTF-8\nexport LANGUAGE=pt_BR:pt\nlocale\n\necho \"[INFO] Iniciando configuração dinâmica do MariaDB Galera\"\nfor v in MARIADB_CLUSTER_NAME SST_USER SST_PASSWORD; do\n  if [ -z \"${!v}\" ]; then\n    echo \"[ERROR] Variável de ambiente $v não definida\"\n    exit 1\n  fi\ndone\n\nordinal=\"${HOSTNAME##*-}\"\nPOD_IP=$(hostname -i)\nexport SERVER_ID=$((100 + ordinal))\n\n# Namespace dinâmico do Kubernetes\nNAMESPACE=\"${POD_NAMESPACE}\"\n\nif [ \"$ordinal\" = \"0\" ]; then\n  export CLUSTER_ADDRESS=\"gcomm://\"\nelse\n  export CLUSTER_ADDRESS=\"${MARIADB_CLUSTER_ADDRESS:-gcomm://mariadb-0.mariadb.${NAMESPACE}.svc.cluster.local:4567}\"\nfi\n\nCONFIG_FILE=\"/etc/mysql/mariadb.conf.d/99-custom.cnf\"\nsed -e \"s/_SERVER_ID/$SERVER_ID/g\" \\\n    -e \"s|_MARIADB_CLUSTER_NAME|$MARIADB_CLUSTER_NAME|g\" \\\n    -e \"s|_MARIADB_CLUSTER_ADDRESS|$CLUSTER_ADDRESS|g\" \\\n    -e \"s|_POD_IP|$POD_IP|g\" \\\n    -e \"s|_SST_USER|$SST_USER|g\" \\\n    -e \"s|_SST_PASSWORD|$SST_PASSWORD|g\" \\\n    /etc/mysql/config-template/custom.cnf \u003e $CONFIG_FILE\n\n# Ajustar gtid_strict_mode apenas nos SLAVES\nif [[ \"$ordinal\" != \"0\" ]]; then\n  echo \"gtid_strict_mode = OFF\" \u003e\u003e \"$CONFIG_FILE\"\nfi\n\nif [[ \"$ordinal\" = \"0\" ]]; then\n  bash /etc/mysql/ensure-users.sh \u0026\nfi\n\necho \"[INFO] Inicializando Galera\"\nif [[ \"$HOSTNAME\" = \"mariadb-0\" ]]; then\n  echo \"[INFO] Inicializando novo cluster Galera\"\n  exec docker-entrypoint.sh mariadbd --defaults-file=$CONFIG_FILE --wsrep-new-cluster\nelse\n  echo \"[INFO] Conectando ao cluster existente\"\n  exec docker-entrypoint.sh mariadbd --defaults-file=$CONFIG_FILE\nfi\n"],"env":[{"name":"POD_NAME","valueFrom":{"fieldRef":{"fieldPath":"metadata.name"}}},{"name":"POD_NAMESPACE","valueFrom":{"fieldRef":{"fieldPath":"metadata.namespace"}}},{"name":"POD_IP","valueFrom":{"fieldRef":{"fieldPath":"status.podIP"}}}],"envFrom":[{"configMapRef":{"name":"mariadb-env-htd7b4942g"}},{"secretRef":{"name":"mariadb-secret-env"}}],"image":"mariadb:11.3.2","imagePullPolicy":"IfNotPresent","livenessProbe":{"exec":{"command":["bash","-c","mariadb-admin ping -u root -p\"${MYSQL_ROOT_PASSWORD}\"\n"]},"initialDelaySeconds":60,"periodSeconds":10,"timeoutSeconds":5},"name":"mariadb","ports":[{"containerPort":3306,"name":"mysql"},{"containerPort":4567,"name":"replication"},{"containerPort":4444,"name":"sst"},{"containerPort":4568,"name":"ist"}],"readinessProbe":{"exec":{"command":["bash","-c","mariadb -u root -p\"${MYSQL_ROOT_PASSWORD}\" -e \"SHOW STATUS LIKE 'wsrep_ready';\" | grep -q \"ON\"\n"]},"failureThreshold":10,"initialDelaySeconds":60,"periodSeconds":10},"resources":{"limits":{"cpu":"1","memory":"2Gi"},"requests":{"cpu":"500m","memory":"512Mi"}},"securityContext":{"runAsGroup":0,"runAsUser":0},"volumeMounts":[{"mountPath":"/var/lib/mysql","name":"database"},{"mountPath":"/etc/mysql/config-template/custom.cnf","name":"mariadb-config","subPath":"custom.cnf"},{"mountPath":"/docker-entrypoint-initdb.d/init-users.sql","name":"init-users","subPath":"init-users.sql"},{"mountPath":"/etc/mysql/ensure-users.sh","name":"ensure-users","subPath":"ensure-users.sh"}]}],"initContainers":[{"command":["/bin/bash","-c","GR=\"/var/lib/mysql/grastate.dat\"\nLOG=\"/var/lib/mysql/wsrep_bootstrap.log\"\n\necho \"[INFO] Checking for safe_to_bootstrap...\" \u003e $LOG\n\nif grep -q 'safe_to_bootstrap: 0' \"$GR\"; then\n  echo \"[INFO] safe_to_bootstrap=0 found\" \u003e\u003e $LOG\n\n  ALL_DOWN=true\n\n  for peer in \"$MARIADB_MASTER_HOST\" \"$MARIADB_MASTER_WORKER1\" \"$MARIADB_MASTER_WORKER2\"; do\n    echo \"[CHECK] nc -z $peer 4567\" \u003e\u003e $LOG\n    if nc -z -w1 \"$peer\" 4567; then\n      echo \"[INFO] Peer $peer is online\" \u003e\u003e $LOG\n      ALL_DOWN=false\n      break\n    else\n      echo \"[INFO] Peer $peer is offline\" \u003e\u003e $LOG\n    fi\n  done\n\n  if $ALL_DOWN; then\n    echo \"[BOOTSTRAP] All peers are down, safe to bootstrap\" \u003e\u003e $LOG\n    sed -i 's/safe_to_bootstrap: 0/safe_to_bootstrap: 1/' \"$GR\"\n  else\n    echo \"[SKIP] Not safe to bootstrap, peers are alive\" \u003e\u003e $LOG\n  fi\nelse\n  echo \"[INFO] No need to patch grastate.dat\" \u003e\u003e $LOG\nfi\n"],"envFrom":[{"configMapRef":{"name":"mariadb-env-htd7b4942g"}},{"secretRef":{"name":"mariadb-secret-env"}}],"image":"mariadb:11.3.2","name":"mariadb-bootstrap-check","securityContext":{"runAsGroup":33,"runAsUser":0},"volumeMounts":[{"mountPath":"/var/lib/mysql","name":"database"}]}],"securityContext":{"fsGroup":999,"fsGroupChangePolicy":"OnRootMismatch","runAsGroup":999,"runAsUser":999},"serviceAccountName":"mariadb","volumes":[{"configMap":{"name":"mariadb-config"},"name":"mariadb-config"},{"configMap":{"name":"config-init-users"},"name":"init-users"},{"configMap":{"defaultMode":493,"name":"config-ensure-users"},"name":"ensure-users"}]}},"volumeClaimTemplates":[{"metadata":{"labels":{"app":"mariadb"},"name":"database"},"spec":{"accessModes":["ReadWriteOnce"],"resources":{"requests":{"storage":"25Gi"}},"storageClassName":"nfs-storage-k8s-v1"}}]}}
    creationTimestamp: "2025-11-15T00:45:32Z"
    generation: 1
    labels:
      app: mariadb
      component: database
    name: mariadb
    namespace: uniselec-api-prd
    resourceVersion: "576701423"
    uid: 95d7befb-765f-4bbd-9aef-05030f40440e
  spec:
    podManagementPolicy: OrderedReady
    replicas: 3
    revisionHistoryLimit: 10
    selector:
      matchLabels:
        app: mariadb
    serviceName: mariadb
    template:
      metadata:
        creationTimestamp: null
        labels:
          app: mariadb
          mariadb/replication-role: member
      spec:
        containers:
        - command:
          - bash
          - -c
          - |
            #!/bin/bash
            # ======================================================
            # CONFIGURAÇÃO INICIAL DO MARIADB:
            # LOCALE PT-BR, CRIAÇÃO DO BANCO PRINCIPAL,
            # USUÁRIO DE APLICAÇÃO, USUÁRIO DE REPLICAÇÃO,
            # E PERMISSÕES DE ACESSO ROOT
            # ======================================================

            set -eo pipefail

            mkdir -p /var/lib/mysql/.sst
            chown -Rf mysql:mysql /var/lib/mysql/.sst
            chmod 700 /var/lib/mysql/.sst

            export DEBIAN_FRONTEND=noninteractive
            apt-get update
            command -v mariabackup || apt-get install -y mariadb-backup
            command -v galera-4 || apt-get install -y galera-4
            command -v pv || apt-get install -y pv

            apt-get install -y locales
            sed -i 's/^# *pt_BR.UTF-8 UTF-8/pt_BR.UTF-8 UTF-8/' /etc/locale.gen
            locale-gen pt_BR.UTF-8
            export LANG=pt_BR.UTF-8
            export LC_ALL=pt_BR.UTF-8
            export LC_CTYPE=pt_BR.UTF-8
            export LANGUAGE=pt_BR:pt
            locale

            echo "[INFO] Iniciando configuração dinâmica do MariaDB Galera"
            for v in MARIADB_CLUSTER_NAME SST_USER SST_PASSWORD; do
              if [ -z "${!v}" ]; then
                echo "[ERROR] Variável de ambiente $v não definida"
                exit 1
              fi
            done

            ordinal="${HOSTNAME##*-}"
            POD_IP=$(hostname -i)
            export SERVER_ID=$((100 + ordinal))

            # Namespace dinâmico do Kubernetes
            NAMESPACE="${POD_NAMESPACE}"

            if [ "$ordinal" = "0" ]; then
              export CLUSTER_ADDRESS="gcomm://"
            else
              export CLUSTER_ADDRESS="${MARIADB_CLUSTER_ADDRESS:-gcomm://mariadb-0.mariadb.${NAMESPACE}.svc.cluster.local:4567}"
            fi

            CONFIG_FILE="/etc/mysql/mariadb.conf.d/99-custom.cnf"
            sed -e "s/_SERVER_ID/$SERVER_ID/g" \
                -e "s|_MARIADB_CLUSTER_NAME|$MARIADB_CLUSTER_NAME|g" \
                -e "s|_MARIADB_CLUSTER_ADDRESS|$CLUSTER_ADDRESS|g" \
                -e "s|_POD_IP|$POD_IP|g" \
                -e "s|_SST_USER|$SST_USER|g" \
                -e "s|_SST_PASSWORD|$SST_PASSWORD|g" \
                /etc/mysql/config-template/custom.cnf > $CONFIG_FILE

            # Ajustar gtid_strict_mode apenas nos SLAVES
            if [[ "$ordinal" != "0" ]]; then
              echo "gtid_strict_mode = OFF" >> "$CONFIG_FILE"
            fi

            if [[ "$ordinal" = "0" ]]; then
              bash /etc/mysql/ensure-users.sh &
            fi

            echo "[INFO] Inicializando Galera"
            if [[ "$HOSTNAME" = "mariadb-0" ]]; then
              echo "[INFO] Inicializando novo cluster Galera"
              exec docker-entrypoint.sh mariadbd --defaults-file=$CONFIG_FILE --wsrep-new-cluster
            else
              echo "[INFO] Conectando ao cluster existente"
              exec docker-entrypoint.sh mariadbd --defaults-file=$CONFIG_FILE
            fi
          env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.name
          - name: POD_NAMESPACE
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.namespace
          - name: POD_IP
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.podIP
          envFrom:
          - configMapRef:
              name: mariadb-env-htd7b4942g
          - secretRef:
              name: mariadb-secret-env
          image: mariadb:11.3.2
          imagePullPolicy: IfNotPresent
          livenessProbe:
            exec:
              command:
              - bash
              - -c
              - |
                mariadb-admin ping -u root -p"${MYSQL_ROOT_PASSWORD}"
            failureThreshold: 3
            initialDelaySeconds: 60
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
          name: mariadb
          ports:
          - containerPort: 3306
            name: mysql
            protocol: TCP
          - containerPort: 4567
            name: replication
            protocol: TCP
          - containerPort: 4444
            name: sst
            protocol: TCP
          - containerPort: 4568
            name: ist
            protocol: TCP
          readinessProbe:
            exec:
              command:
              - bash
              - -c
              - |
                mariadb -u root -p"${MYSQL_ROOT_PASSWORD}" -e "SHOW STATUS LIKE 'wsrep_ready';" | grep -q "ON"
            failureThreshold: 10
            initialDelaySeconds: 60
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 1
          resources:
            limits:
              cpu: "1"
              memory: 2Gi
            requests:
              cpu: 500m
              memory: 512Mi
          securityContext:
            runAsGroup: 0
            runAsUser: 0
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
          - mountPath: /var/lib/mysql
            name: database
          - mountPath: /etc/mysql/config-template/custom.cnf
            name: mariadb-config
            subPath: custom.cnf
          - mountPath: /docker-entrypoint-initdb.d/init-users.sql
            name: init-users
            subPath: init-users.sql
          - mountPath: /etc/mysql/ensure-users.sh
            name: ensure-users
            subPath: ensure-users.sh
        dnsPolicy: ClusterFirst
        initContainers:
        - command:
          - /bin/bash
          - -c
          - |
            GR="/var/lib/mysql/grastate.dat"
            LOG="/var/lib/mysql/wsrep_bootstrap.log"

            echo "[INFO] Checking for safe_to_bootstrap..." > $LOG

            if grep -q 'safe_to_bootstrap: 0' "$GR"; then
              echo "[INFO] safe_to_bootstrap=0 found" >> $LOG

              ALL_DOWN=true

              for peer in "$MARIADB_MASTER_HOST" "$MARIADB_MASTER_WORKER1" "$MARIADB_MASTER_WORKER2"; do
                echo "[CHECK] nc -z $peer 4567" >> $LOG
                if nc -z -w1 "$peer" 4567; then
                  echo "[INFO] Peer $peer is online" >> $LOG
                  ALL_DOWN=false
                  break
                else
                  echo "[INFO] Peer $peer is offline" >> $LOG
                fi
              done

              if $ALL_DOWN; then
                echo "[BOOTSTRAP] All peers are down, safe to bootstrap" >> $LOG
                sed -i 's/safe_to_bootstrap: 0/safe_to_bootstrap: 1/' "$GR"
              else
                echo "[SKIP] Not safe to bootstrap, peers are alive" >> $LOG
              fi
            else
              echo "[INFO] No need to patch grastate.dat" >> $LOG
            fi
          envFrom:
          - configMapRef:
              name: mariadb-env-htd7b4942g
          - secretRef:
              name: mariadb-secret-env
          image: mariadb:11.3.2
          imagePullPolicy: IfNotPresent
          name: mariadb-bootstrap-check
          resources: {}
          securityContext:
            runAsGroup: 33
            runAsUser: 0
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
          - mountPath: /var/lib/mysql
            name: database
        restartPolicy: Always
        schedulerName: default-scheduler
        securityContext:
          fsGroup: 999
          fsGroupChangePolicy: OnRootMismatch
          runAsGroup: 999
          runAsUser: 999
        serviceAccount: mariadb
        serviceAccountName: mariadb
        terminationGracePeriodSeconds: 30
        volumes:
        - configMap:
            defaultMode: 420
            name: mariadb-config
          name: mariadb-config
        - configMap:
            defaultMode: 420
            name: config-init-users
          name: init-users
        - configMap:
            defaultMode: 493
            name: config-ensure-users
          name: ensure-users
    updateStrategy:
      rollingUpdate:
        partition: 0
      type: RollingUpdate
    volumeClaimTemplates:
    - apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        creationTimestamp: null
        labels:
          app: mariadb
        name: database
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 25Gi
        storageClassName: nfs-storage-k8s-v1
        volumeMode: Filesystem
      status:
        phase: Pending
  status:
    availableReplicas: 3
    collisionCount: 0
    currentReplicas: 3
    currentRevision: mariadb-54fd9f6945
    observedGeneration: 1
    readyReplicas: 3
    replicas: 3
    updateRevision: mariadb-54fd9f6945
    updatedReplicas: 3
kind: List
metadata:
  resourceVersion: ""
