apiVersion: apps/v1
kind: Deployment
metadata:
  name: restore-admin
  labels:
    app: mariadb
    component: restore-admin
spec:
  replicas: 0
  selector:
    matchLabels:
      app: mariadb
      component: restore-admin
  template:
    metadata:
      labels:
        app: mariadb
        component: restore-admin
    spec:
      serviceAccountName: mariadb
      tolerations:
      - effect: NoSchedule
        operator: Exists
      containers:
      - name: restore-admin
        image: mariadb:10.11.15-jammy
        imagePullPolicy: IfNotPresent
        command:
        - /bin/bash
        - -c
        - |
          echo "================================================================"
          echo "RESTORE ADMIN POD - MariaDB Galera"
          echo "================================================================"
          echo ""
          echo "Pod iniciado em: $(date)"
          echo "Hostname: $(hostname)"
          echo ""
          echo "Este pod permite executar restore de forma interativa."
          echo ""
          echo "Scripts dispon√≠veis:"
          echo "  /scripts/list-backups.sh             - Listar backups"
          echo "  /scripts/verify-backup.sh TIMESTAMP  - Verificar backup"
          echo "  /scripts/execute-restore-safe.sh TIMESTAMP - Executar restore"
          echo ""
          echo "Exemplo de uso:"
          echo "  kubectl exec -it restore-admin-xxx -- /bin/bash"
          echo "  # /scripts/list-backups.sh"
          echo "  # /scripts/verify-backup.sh 20251210-020000"
          echo "  # /scripts/execute-restore-safe.sh 20251210-020000"
          echo ""
          echo "================================================================"
          echo "Aguardando comandos... (Pod em sleep infinito)"
          echo "================================================================"
          echo ""

          # Sleep infinito para manter o pod rodando
          while true; do
            sleep 3600
          done

        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mariadb-secret-env
              key: MYSQL_ROOT_PASSWORD
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        volumeMounts:
        # 1. Scripts de backup/restore do ConfigMap
        - name: backup-scripts
          mountPath: /scripts
          readOnly: true
        # 2. Volume de backup (NFS)
        - name: backup-volume
          mountPath: /backup
        # 3. Datadir do mariadb-0
        # Montar mesmo PVC do mariadb-0
        - name: mariadb-data
          mountPath: /var/lib/mysql
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
        securityContext:
          runAsUser: 999
          runAsGroup: 999
          fsGroup: 999
          capabilities:
            add:
            - SYS_NICE
      volumes:
      # 1. Scripts do ConfigMap
      - name: backup-scripts
        configMap:
          name: mariadb-backup-scripts
          defaultMode: 0755
      # 2. Volume de backup (NFS) - PVC compartilhado
      - name: backup-volume
        persistentVolumeClaim:
          claimName: mariadb-backup-pvc
      # 3. Datadir do mariadb-0
      - name: mariadb-data
        persistentVolumeClaim:
          claimName: database-mariadb-0
      restartPolicy: Always
      affinity:
        podAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: statefulset.kubernetes.io/pod-name
                  operator: In
                  values:
                  - mariadb-0
              topologyKey: kubernetes.io/hostname
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mariadb-backup-pvc
  labels:
    app: mariadb
    component: backup
spec:
  accessModes:
  - ReadWriteMany
  storageClassName: nfs-storage-k8s-v1
  resources:
    requests:
      storage: 500Gi
  volumeMode: Filesystem