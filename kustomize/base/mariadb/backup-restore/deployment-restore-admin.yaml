apiVersion: apps/v1
kind: Deployment
metadata:
  name: disaster-recovery-admin
  labels:
    app: mariadb
    component: disaster-recovery
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mariadb
      component: disaster-recovery
  template:
    metadata:
      labels:
        app: mariadb
        component: disaster-recovery
    spec:
      serviceAccountName: mariadb-backup
      tolerations:
      - effect: NoSchedule
        operator: Exists
      securityContext:
        fsGroup: 999

      initContainers:
      - name: tools
        image: mariadb:10.11.15-jammy
        command: ["/bin/bash", "-c"]
        args:
        - |
          set -e

          apt-get update -qq
          apt-get install -y -qq curl ca-certificates
          curl -LO "https://dl.k8s.io/release/v1.31.3/bin/linux/amd64/kubectl"
          chmod +x kubectl
          mv kubectl /shared/kubectl

          /shared/kubectl version --client | head -1
        volumeMounts:
        - name: shared-bin
          mountPath: /shared

      containers:
      - name: disaster-recovery-admin
        image: mariadb:10.11.15-jammy
        imagePullPolicy: IfNotPresent
        command:
        - /bin/bash
        - -c
        - |
          echo "================================================================"
          echo "DISASTER RECOVERY ADMIN - MariaDB Galera"
          echo "================================================================"
          echo ""
          echo "Pod iniciado em: $(date)"
          echo "Hostname: $(hostname)"
          echo ""
          echo "Este pod permite backup e restore de forma interativa."
          echo ""
          echo "Scripts dispon√≠veis:"
          echo "  /scripts/manual-backup.sh                  - Fazer backup manual"
          echo "  /scripts/list-backups.sh                   - Listar backups"
          echo "  /scripts/verify-backup.sh TIMESTAMP        - Verificar backup"
          echo "  /scripts/execute-restore-safe.sh TIMESTAMP - Executar restore"
          echo ""
          echo "Exemplo de uso:"
          echo "  kubectl exec -it disaster-recovery-admin-xxx -- /bin/bash"
          echo "  # /scripts/manual-backup.sh"
          echo "  # /scripts/list-backups.sh"
          echo "  # /scripts/verify-backup.sh 20251210-020000"
          echo "  # /scripts/execute-restore-safe.sh 20251210-020000"
          echo ""
          echo "Testes:"
          echo "  kubectl delete job test-backup-now -n uniselec-api-dev"
          echo "  kubectl create job --from=cronjob/mariadb-backup-daily test-backup-now -n uniselec-api-dev"
          echo "  kubectl logs -f job/test-backup-now -n uniselec-api-dev"
          echo ""
          echo "================================================================"
          echo "Aguardando comandos..."
          echo "================================================================"
          echo ""

          while true; do
            sleep 3600
          done

        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mariadb-secret-env
              key: MYSQL_ROOT_PASSWORD
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: PATH
          value: "/shared:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

        volumeMounts:
        - name: backup-scripts
          mountPath: /scripts
          readOnly: true
        - name: backup-volume
          mountPath: /backup
        - name: mariadb-data
          mountPath: /var/lib/mysql
        - name: shared-bin
          mountPath: /shared

        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi

        securityContext:
          runAsUser: 999
          runAsGroup: 999
          capabilities:
            add:
            - SYS_NICE

      volumes:
      - name: backup-scripts
        configMap:
          name: mariadb-backup-scripts
          defaultMode: 0755
      - name: backup-volume
        persistentVolumeClaim:
          claimName: backup-mariadb-1
      - name: mariadb-data
        persistentVolumeClaim:
          claimName: database-mariadb-0
      - name: shared-bin
        emptyDir: {}

      restartPolicy: Always
      affinity:
        podAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: statefulset.kubernetes.io/pod-name
                  operator: In
                  values:
                  - mariadb-0
              topologyKey: kubernetes.io/hostname