apiVersion: v1
kind: ConfigMap
metadata:
  name: mariadb-backup-scripts
  labels:
    app: mariadb
    component: backup
data:
  # BACKUP GALERA AUTOMÁTICO (CronJob)
  backup-galera-automated.sh: |
    #!/bin/bash
    set -euo pipefail

    log() {
      echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a /backup/backup.log
    }

    error() {
      echo "[ERROR][$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a /backup/backup.log
      exit 1
    }

    HOSTNAME=$(hostname)
    ORDINAL="${HOSTNAME##*-}"

    # Backup apenas em nós secundários (mariadb-1)
    if [ "$ORDINAL" != "1" ]; then
      log "Skip: Backup automático executa apenas em mariadb-1"
      exit 0
    fi

    # MESMO FORMATO QUE BACKUP MANUAL
    TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    BACKUP_DIR="/backup/auto-${TIMESTAMP}"  # Prefixo 'auto-' para CronJob

    mkdir -p "$BACKUP_DIR"

    log "=== BACKUP AUTOMÁTICO GALERA ==="
    log "Pod: $HOSTNAME"
    log "Dir: $BACKUP_DIR"

    # Verificar MariaDB
    if ! mariadb-admin ping -u root -p"${MYSQL_ROOT_PASSWORD}" --silent; then
      error "MariaDB não responde"
    fi

    # ======================================================
    # BACKUP FÍSICO - MESMO MÉTODO DO SCRIPT MANUAL
    # ======================================================
    log "Executando mariadb-backup (streaming)..."

    mariadb-backup \
      --backup \
      --user=root \
      --password="${MYSQL_ROOT_PASSWORD}" \
      --target-dir=$BACKUP_DIR \
      --stream=mbstream \
      --parallel=2 > $BACKUP_DIR/backup.mbstream

    if [ $? -ne 0 ]; then
      error "Backup falhou"
    fi

    log "Backup stream completo"

    # Checksum (compatível com script manual)
    md5sum $BACKUP_DIR/backup.mbstream > $BACKUP_DIR/backup.mbstream.md5
    ls -lh $BACKUP_DIR/backup.mbstream | awk '{print $5}' > $BACKUP_DIR/backup.size

    # ======================================================
    # PREPARAÇÃO DO BACKUP
    # ======================================================
    log "Preparando backup..."

    cd $BACKUP_DIR
    mbstream -x < backup.mbstream

    mariadb-backup \
      --prepare \
      --target-dir=$BACKUP_DIR

    if [ $? -ne 0 ]; then
      error "Preparação falhou"
    fi

    # Validar xtrabackup_checkpoints
    if [ ! -f "$BACKUP_DIR/xtrabackup_checkpoints" ]; then
      error "xtrabackup_checkpoints não encontrado"
    fi

    log "Backup preparado"

    # ======================================================
    # METADADOS DO CLUSTER
    # ======================================================
    cat > $BACKUP_DIR/cluster-info.txt <<CLUSTERINFO
    Backup Type: AUTOMATED (CronJob)
    Timestamp: $TIMESTAMP
    Pod: $HOSTNAME
    Namespace: ${POD_NAMESPACE:-uniselec-api-prd}

    === CLUSTER STATUS ===
    CLUSTERINFO

    mariadb -uroot -p"${MYSQL_ROOT_PASSWORD}" -e "
      SELECT NOW() as backup_time;
      SHOW STATUS LIKE 'wsrep%';
    " >> $BACKUP_DIR/cluster-info.txt 2>/dev/null || true

    # ======================================================
    # VALIDAÇÃO
    # ======================================================
    log "Validando backup..."

    # Checksum
    cd $BACKUP_DIR
    if ! md5sum -c backup.mbstream.md5 2>/dev/null; then
      error "Checksum inválido"
    fi

    # Arquivos obrigatórios
    required_files=(
      'xtrabackup_checkpoints'
      'xtrabackup_info'
      'ibdata1'
    )

    for file in "${required_files[@]}"; do
      if [ ! -f "$file" ]; then
        error "Arquivo obrigatório faltando: $file"
      fi
    done

    log "Backup validado"

    # ======================================================
    # LIMPEZA DE BACKUPS ANTIGOS
    # ======================================================
    log "Limpando backups > 7 dias..."
    find /backup -maxdepth 1 -name "auto-*" -type d -mtime +7 -exec rm -rf {} \; 2>/dev/null || true
    find /backup -maxdepth 1 -name "manual-*" -type d -mtime +7 -exec rm -rf {} \; 2>/dev/null || true
    find /backup -name "backup-*.log" -mtime +7 -delete 2>/dev/null || true

    # ======================================================
    # RELATÓRIO FINAL
    # ======================================================
    BACKUP_SIZE=$(du -sh "$BACKUP_DIR" | cut -f1)
    log "=== BACKUP COMPLETO ==="
    log "ID: $TIMESTAMP"
    log "Tamanho: $BACKUP_SIZE"
    log "Local: $BACKUP_DIR"

    echo "SUCCESS:$TIMESTAMP:automated" > "/backup/last_backup_status"

    log "Backup finalizado"

  # LISTAR BACKUPS (AUTOMÁTICOS E MANUAIS)
  list-backups.sh: |
    #!/bin/bash

    echo "=== BACKUPS DISPONÍVEIS ==="
    echo ""
    echo "Formato: TIMESTAMP | TAMANHO | TIPO | STATUS"
    echo "-----------------------------------------------------"

    # Listar TODOS os backups (auto-* e manual-*)
    for backup_dir in /backup/auto-* /backup/manual-*; do
      if [ -d "$backup_dir" ]; then
        basename_dir=$(basename "$backup_dir")

        # Extrair tipo e timestamp
        if [[ $basename_dir =~ ^auto-(.*)$ ]]; then
          tipo="AUTO"
          timestamp="${BASH_REMATCH[1]}"
        elif [[ $basename_dir =~ ^manual-(.*)$ ]]; then
          tipo="MANUAL"
          timestamp="${BASH_REMATCH[1]}"
        else
          continue
        fi

        size=$(du -sh "$backup_dir" 2>/dev/null | cut -f1)

        # Verificar integridade
        if [ -f "$backup_dir/xtrabackup_checkpoints" ] && \
           [ -f "$backup_dir/ibdata1" ] && \
           [ -f "$backup_dir/backup.mbstream.md5" ]; then
          status="✓ PRONTO"
        else
          status="✗ INCOMPLETO"
        fi

        printf "%-17s | %-8s | %-6s | %s\n" "$timestamp" "$size" "$tipo" "$status"
      fi
    done | sort -r

    echo ""
    echo "Total de backups: $(find /backup -maxdepth 1 \( -name "auto-*" -o -name "manual-*" \) -type d 2>/dev/null | wc -l)"

    # Status do último backup
    if [ -f "/backup/last_backup_status" ]; then
      echo ""
      echo "Último backup: $(cat /backup/last_backup_status)"
    fi

    echo ""
    echo "Para restaurar um backup:"
    echo "  /scripts/execute-restore-safe.sh <timestamp>"
    echo "  Exemplo: /scripts/execute-restore-safe.sh 20251130-124024"

  # VERIFICAR BACKUP (AUTOMÁTICO OU MANUAL)
  verify-backup.sh: |
    #!/bin/bash

    if [ -z "$1" ]; then
      echo "Uso: $0 <timestamp>"
      echo "Exemplo: $0 20251130-124024"
      exit 1
    fi

    TIMESTAMP="$1"

    # Procurar backup (auto ou manual)
    BACKUP_DIR=""
    if [ -d "/backup/auto-${TIMESTAMP}" ]; then
      BACKUP_DIR="/backup/auto-${TIMESTAMP}"
      TIPO="AUTOMÁTICO"
    elif [ -d "/backup/manual-${TIMESTAMP}" ]; then
      BACKUP_DIR="/backup/manual-${TIMESTAMP}"
      TIPO="MANUAL"
    else
      echo "Backup não encontrado: $TIMESTAMP"
      echo "Use /scripts/list-backups.sh para ver backups disponíveis"
      exit 1
    fi

    echo "Verificando backup: $TIMESTAMP"
    echo "Tipo: $TIPO"
    echo "Local: $BACKUP_DIR"
    echo "========================="

    # Verificar checksum
    echo -n "Checksum MD5: "
    if [ -f "$BACKUP_DIR/backup.mbstream.md5" ]; then
      cd "$BACKUP_DIR"
      if md5sum -c backup.mbstream.md5 2>/dev/null; then
        echo "OK"
      else
        echo "FALHOU"
      fi
    else
      echo "NÃO ENCONTRADO"
    fi

    # Verificar xtrabackup_checkpoints
    echo -n "xtrabackup_checkpoints: "
    if [ -f "$BACKUP_DIR/xtrabackup_checkpoints" ]; then
      echo "OK"
      echo "  $(cat "$BACKUP_DIR/xtrabackup_checkpoints" | grep backup_type)"
      echo "  $(cat "$BACKUP_DIR/xtrabackup_checkpoints" | grep to_lsn)"
    else
      echo "NÃO ENCONTRADO"
    fi

    # Verificar arquivos críticos
    echo -n "Arquivos críticos: "
    required_files=('xtrabackup_info' 'ibdata1')
    missing=0
    for file in "${required_files[@]}"; do
      if [ ! -f "$BACKUP_DIR/$file" ]; then
        echo "FALTANDO: $file"
        missing=1
      fi
    done
    if [ $missing -eq 0 ]; then
      echo "OK"
    fi

    # Verificar cluster-info
    if [ -f "$BACKUP_DIR/cluster-info.txt" ]; then
      echo ""
      echo "=== INFORMAÇÕES DO CLUSTER ==="
      head -20 "$BACKUP_DIR/cluster-info.txt"
    fi

    echo "========================="

    # Status final
    if [ $missing -eq 0 ] && [ -f "$BACKUP_DIR/xtrabackup_checkpoints" ]; then
      echo "Status: ✓ PRONTO PARA RESTORE"
      echo ""
      echo "Comando de restore:"
      echo "  /scripts/execute-restore-safe.sh $TIMESTAMP"
      exit 0
    else
      echo "Status: ✗ BACKUP INCOMPLETO"
      exit 1
    fi

  # EXECUTAR RESTORE (AUTOMÁTICO OU MANUAL)
  execute-restore-safe.sh: |
    #!/bin/bash
    set -euo pipefail

    if [ -z "$1" ]; then
      echo "Uso: $0 <timestamp>"
      echo ""
      echo "Para listar backups disponíveis:"
      echo "  /scripts/list-backups.sh"
      exit 1
    fi

    TIMESTAMP="$1"

    # Procurar backup (auto ou manual)
    BACKUP_DIR=""
    if [ -d "/backup/auto-${TIMESTAMP}" ]; then
      BACKUP_DIR="/backup/auto-${TIMESTAMP}"
      TIPO="AUTOMÁTICO"
    elif [ -d "/backup/manual-${TIMESTAMP}" ]; then
      BACKUP_DIR="/backup/manual-${TIMESTAMP}"
      TIPO="MANUAL"
    else
      echo "ERRO: Backup não encontrado: $TIMESTAMP"
      echo ""
      echo "Backups disponíveis:"
      /scripts/list-backups.sh
      exit 1
    fi

    echo "=== EXECUTANDO RESTORE ==="
    echo "Timestamp: $TIMESTAMP"
    echo "Tipo: $TIPO"
    echo "Source: $BACKUP_DIR"
    echo "Target: /var/lib/mysql"
    echo ""

    # Validar backup
    if [ ! -f "$BACKUP_DIR/xtrabackup_checkpoints" ]; then
      echo "ERRO: Backup inválido - xtrabackup_checkpoints não encontrado"
      exit 1
    fi

    if [ ! -f "$BACKUP_DIR/ibdata1" ]; then
      echo "ERRO: Backup inválido - ibdata1 não encontrado"
      exit 1
    fi

    echo "Backup validado"

    # Parar MariaDB (se rodando)
    echo "Parando MariaDB..."
    pkill -f mariadbd || true
    sleep 10
    pkill -9 -f mariadbd || true
    sleep 5

    # Backup de segurança dos dados atuais
    echo "Criando backup de segurança..."
    SAFETY_BACKUP="/backup/pre-restore-safety-$(date +%Y%m%d-%H%M%S)"
    mkdir -p "$SAFETY_BACKUP"

    if [ -d "/var/lib/mysql" ] && [ "$(ls -A /var/lib/mysql 2>/dev/null)" ]; then
      # Copiar apenas arquivos críticos (rápido)
      cp /var/lib/mysql/grastate.dat "$SAFETY_BACKUP/" 2>/dev/null || true
      cp /var/lib/mysql/ibdata1 "$SAFETY_BACKUP/" 2>/dev/null || true
      cp /var/lib/mysql/xtrabackup_* "$SAFETY_BACKUP/" 2>/dev/null || true

      echo "Backup de segurança: $SAFETY_BACKUP"
    fi

    # Limpar datadir
    echo "Limpando datadir..."
    find /var/lib/mysql -mindepth 1 -delete

    # Executar restore
    echo "Executando mariadb-backup --copy-back..."
    mariadb-backup \
      --copy-back \
      --target-dir=$BACKUP_DIR \
      --datadir=/var/lib/mysql

    if [ $? -ne 0 ]; then
      echo "ERRO: mariadb-backup --copy-back falhou!"
      exit 1
    fi

    echo "Restore completado"

    # Corrigir permissões
    echo "Corrigindo permissões..."
    chown -R 999:999 /var/lib/mysql

    # Configurar bootstrap Galera
    echo "Configurando bootstrap Galera..."
    cat > /var/lib/mysql/grastate.dat <<'GRASTATE'
    # WSREP saved state - RESTORE POINT
    version: 2.1
    uuid:    00000000-0000-0000-0000-000000000000
    seqno:   -1
    safe_to_bootstrap: 1
    GRASTATE

    # Validar restore
    echo "Validando restore..."
    if [ -f /var/lib/mysql/ibdata1 ] && [ -d /var/lib/mysql/mysql ]; then
      echo "✓ Restore validado com sucesso"
      ls -lh /var/lib/mysql/ | head -20
    else
      echo "✗ Restore incompleto!"
      exit 1
    fi

    echo ""
    echo "=== RESTORE CONCLUÍDO ==="
    echo ""
    echo "PRÓXIMOS PASSOS:"
    echo "1. Sair do pod restore-admin"
    echo "2. Iniciar cluster:"
    echo "   kubectl scale statefulset mariadb -n uniselec-api-prd --replicas=1"
    echo "   # Aguardar mariadb-0 ficar Synced"
    echo "   kubectl scale statefulset mariadb -n uniselec-api-prd --replicas=3"
    echo ""

    echo "RESTORE_SUCCESS:$TIMESTAMP:$TIPO" > "/backup/last_restore_status"